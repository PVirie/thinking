version: "3"
services:
    main-gpu:
        profiles: ["gpu"]
        build:
            dockerfile: ./Dockerfile
            context: .
        container_name: thinking-gpu
        restart: no
        volumes:
            - ./artifacts/log/metric:/app/log
            - ./artifacts/cache/metric:/app/cache
            - ./artifacts/experiments:/app/experiments
            - ./humn:/app/humn
            - ./core:/app/core
            - ./jax_onehot:/app/jax_onehot
            - ./tasks:/app/tasks
        environment:
            - ERROR_LOG=/app/log/error.log
            - LOG_LEVEL=info
            - PYTHONUNBUFFERED=TRUE
            - TF_CPP_MIN_LOG_LEVEL=0
        env_file:
            - ./secrets.env
        ports:
            - "127.0.0.1:5678:5678"
        networks:
            - app_network
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          count: 1
                          capabilities: [gpu]
    main:
        profiles: ["cpu"]
        build:
            dockerfile: ./Dockerfile.nogpu
            context: .
        container_name: thinking-cpu
        restart: no
        volumes:
            - ./artifacts/log/metric:/app/log
            - ./artifacts/cache/metric:/app/cache
            - ./artifacts/experiments:/app/experiments
            - ./humn:/app/humn
            - ./core:/app/core
            - ./jax_onehot:/app/jax_onehot
            - ./tasks:/app/tasks
        environment:
            - ERROR_LOG=/app/log/error.log
            - LOG_LEVEL=info
            - PYTHONUNBUFFERED=TRUE
            - TF_CPP_MIN_LOG_LEVEL=0
        env_file:
            - ./secrets.env
        ports:
            - "127.0.0.1:5678:5678"
        networks:
            - app_network
    api-call:
        profiles: ["api-call"]
        build:
            dockerfile: ./Dockerfile.pure_python
            context: .
        container_name: thinking-api-call
        restart: no
        volumes:
            - ./artifacts/log/metric:/app/log
            - ./artifacts/cache/metric:/app/cache
            - ./artifacts/experiments:/app/experiments
            - ./humn:/app/humn
            - ./core:/app/core
            - ./llm:/app/llm
            - ./tasks:/app/tasks
        environment:
            - ERROR_LOG=/app/log/error.log
            - LOG_LEVEL=info
            - PYTHONUNBUFFERED=TRUE
            - TF_CPP_MIN_LOG_LEVEL=0
        env_file:
            - ./secrets.env
        ports:
            - "127.0.0.1:5679:5678"
        networks:
            - app_network
    torch-cpu:
        profiles: ["torch-cpu"]
        build:
            dockerfile: ./Dockerfile.nogpu_torch
            context: .
        container_name: thinking-cpu-torch
        restart: no
        volumes:
            - ./artifacts/log/metric:/app/log
            - ./artifacts/cache/metric:/app/cache
            - ./artifacts/experiments:/app/experiments
            - ./humn:/app/humn
            - ./core:/app/core
            - ./jax_onehot:/app/jax_onehot
            - ./tasks:/app/tasks
        environment:
            - ERROR_LOG=/app/log/error.log
            - LOG_LEVEL=info
            - PYTHONUNBUFFERED=TRUE
            - TF_CPP_MIN_LOG_LEVEL=0
        env_file:
            - ./secrets.env
        ports:
            - "127.0.0.1:5680:5678"
        networks:
            - app_network
networks:
    app_network:
        driver: bridge
